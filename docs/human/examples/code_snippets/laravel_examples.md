# ๐ ุฃูุซูุฉ Laravel ูุชูุฏูุฉ

## 1. ุฎุฏูุฉ ุงูุชูุงูู ุงูุญูููู - ูุซุงู ุญูููู

```php
<?php

namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Cache;
use App\Models\GovernmentRequest;

class GovernmentIntegrationService
{
    private $apiUrl;
    private $apiKey;
    
    public function __construct()
    {
        $this->apiUrl = config('services.government.url');
        $this->apiKey = config('services.government.key');
    }
    
    /**
     * ุงูุชุญูู ูู ุงููููุฉ ุงููุทููุฉ
     */
    public function verifyNationalId($nationalId)
    {
        // ุชุฎุฒูู ูุคูุช ูููุชุงุฆุฌ ูุชูููู ุงูุทูุจุงุช
        return Cache::remember("gov_id_{$nationalId}", 3600, function () use ($nationalId) {
            $response = Http::withHeaders([
                'Authorization' => 'Bearer ' . $this->apiKey,
                'Accept' => 'application/json',
            ])->post($this->apiUrl . '/verify/national-id', [
                'national_id' => $nationalId
            ]);
            
            if ($response->successful()) {
                // ุชุณุฌูู ุงูุทูุจ ุงููุงุฌุญ
                GovernmentRequest::create([
                    'type' => 'national_id_verification',
                    'request_data' => ['national_id' => $nationalId],
                    'response_data' => $response->json(),
                    'status' => 'success'
                ]);
                
                return $response->json();
            }
            
            throw new \Exception('ูุดู ุงูุชุญูู ูู ุงููููุฉ');
        });
    }
    
    /**
     * ุงูุญุตูู ุนูู ุชูุงุตูู ุงูุฑุฎุตุฉ ุงูุชุฌุงุฑูุฉ
     */
    public function getBusinessLicense($licenseNumber)
    {
        return Cache::remember("gov_license_{$licenseNumber}", 7200, function () use ($licenseNumber) {
            $response = Http::timeout(30)
                ->retry(3, 100)
                ->withHeaders([
                    'Authorization' => 'Bearer ' . $this->apiKey,
                ])
                ->get($this->apiUrl . '/business/license/' . $licenseNumber);
            
            return $response->json();
        });
    }
}
```

## 2. ุฎุฏูุฉ ุงููุฏููุนุงุช ุงููุชูุฏูุฉ

```php
<?php

namespace App\Services;

use App\Models\Payment;
use App\Models\Order;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class PaymentService
{
    /**
     * ูุนุงูุฌุฉ ุฏูุนุฉ ุขููุฉ ูุน ุฅุฏุงุฑุฉ ุงููุนุงููุงุช
     */
    public function processPayment(Order $order, array $paymentData)
    {
        return DB::transaction(function () use ($order, $paymentData) {
            try {
                // ุฅูุดุงุก ุณุฌู ุงูุฏูุน
                $payment = Payment::create([
                    'order_id' => $order->id,
                    'amount' => $order->total_amount,
                    'currency' => 'SAR',
                    'method' => $paymentData['method'],
                    'status' => 'pending'
                ]);
                
                // ูุนุงูุฌุฉ ุญุณุจ ููุน ุงูุฏูุน
                switch ($paymentData['method']) {
                    case 'credit_card':
                        $result = $this->processCreditCard($payment, $paymentData);
                        break;
                    case 'bank_transfer':
                        $result = $this->processBankTransfer($payment, $paymentData);
                        break;
                    case 'cash_on_delivery':
                        $result = $this->processCOD($payment, $order);
                        break;
                    default:
                        throw new \Exception('ุทุฑููุฉ ุฏูุน ุบูุฑ ูุฏุนููุฉ');
                }
                
                // ุชุญุฏูุซ ุญุงูุฉ ุงูุฏูุน
                $payment->update([
                    'status' => $result['status'],
                    'transaction_id' => $result['transaction_id'] ?? null,
                    'processed_at' => now()
                ]);
                
                // ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ
                if ($result['status'] === 'completed') {
                    $order->update(['status' => 'paid']);
                    
                    // ุฅุฑุณุงู ุฅุดุนุงุฑ ููุนููู
                    $order->user->notify(new PaymentSuccessNotification($payment));
                }
                
                return $payment;
                
            } catch (\Exception $e) {
                Log::error('Payment processing failed', [
                    'order_id' => $order->id,
                    'error' => $e->getMessage()
                ]);
                
                throw $e;
            }
        });
    }
    
    private function processCreditCard($payment, $data)
    {
        // ุชุดููุฑ ุจูุงูุงุช ุงูุจุทุงูุฉ
        $encryptedCard = encrypt($data['card_number']);
        
        // ุงุณุชุฏุนุงุก ุจูุงุจุฉ ุงูุฏูุน
        // ... ููุฏ ุงูุชูุงูู ูุน ุจูุงุจุฉ ุงูุฏูุน
        
        return [
            'status' => 'completed',
            'transaction_id' => 'TRX' . time()
        ];
    }
}
```

## 3. ูุธุงู ุงูุชูุตูุงุช ุงูุฐูู

```php
<?php

namespace App\Services;

use App\Models\User;
use App\Models\Product;
use Illuminate\Support\Facades\Cache;

class RecommendationService
{
    /**
     * ุงูุญุตูู ุนูู ุชูุตูุงุช ูุฎุตุตุฉ ูููุณุชุฎุฏู
     */
    public function getPersonalizedRecommendations(User $user, $limit = 10)
    {
        return Cache::remember("user_recommendations_{$user->id}", 3600, function () use ($user, $limit) {
            // ุชุญููู ุณููู ุงููุณุชุฎุฏู
            $userBehavior = $this->analyzeUserBehavior($user);
            
            // ุงูุญุตูู ุนูู ุงูููุชุฌุงุช ุงููุดุงุจูุฉ
            $recommendations = Product::query()
                ->whereIn('category_id', $userBehavior['preferred_categories'])
                ->whereNotIn('id', $userBehavior['purchased_products'])
                ->withAvg('reviews', 'rating')
                ->having('reviews_avg_rating', '>=', 4)
                ->orderByDesc('reviews_avg_rating')
                ->limit($limit)
                ->get();
            
            // ุฅุถุงูุฉ ููุงุท ุงูุชูุตูุฉ
            return $recommendations->map(function ($product) use ($userBehavior) {
                $score = $this->calculateRecommendationScore($product, $userBehavior);
                $product->recommendation_score = $score;
                return $product;
            })->sortByDesc('recommendation_score');
        });
    }
    
    private function analyzeUserBehavior(User $user)
    {
        return [
            'preferred_categories' => $user->orders()
                ->join('order_items', 'orders.id', '=', 'order_items.order_id')
                ->join('products', 'order_items.product_id', '=', 'products.id')
                ->groupBy('products.category_id')
                ->pluck('products.category_id')
                ->toArray(),
                
            'purchased_products' => $user->orders()
                ->join('order_items', 'orders.id', '=', 'order_items.order_id')
                ->pluck('order_items.product_id')
                ->toArray(),
                
            'average_price' => $user->orders()
                ->avg('total_amount'),
                
            'purchase_frequency' => $user->orders()
                ->whereBetween('created_at', [now()->subMonths(6), now()])
                ->count()
        ];
    }
    
    private function calculateRecommendationScore($product, $userBehavior)
    {
        $score = 0;
        
        // ููุงุท ููุณุนุฑ ุงูููุงุณุจ
        if (abs($product->price - $userBehavior['average_price']) < 100) {
            $score += 30;
        }
        
        // ููุงุท ููุชููููุงุช ุงูุนุงููุฉ
        $score += $product->reviews_avg_rating * 10;
        
        // ููุงุท ููููุชุฌุงุช ุงูุฌุฏูุฏุฉ
        if ($product->created_at->gt(now()->subDays(30))) {
            $score += 20;
        }
        
        return $score;
    }
}
```

## 4. ุชุญุณูู ุงูุงุณุชุนูุงูุงุช ุงููุนูุฏุฉ

```php
<?php

// ุจุฏูุงู ูู N+1 queries
$orders = Order::all();
foreach ($orders as $order) {
    echo $order->user->name; // ุงุณุชุนูุงู ุฅุถุงูู ููู ุทูุจ!
}

// ุงูุญู ุงูุฃูุซู
$orders = Order::with(['user', 'items.product'])->get();
foreach ($orders as $order) {
    echo $order->user->name; // ูุง ุงุณุชุนูุงูุงุช ุฅุถุงููุฉ
}

// ุงุณุชุนูุงู ูุนูุฏ ูุญุณู
$topProducts = Product::query()
    ->select('products.*')
    ->selectRaw('COUNT(DISTINCT order_items.order_id) as order_count')
    ->selectRaw('SUM(order_items.quantity) as total_sold')
    ->selectRaw('AVG(reviews.rating) as avg_rating')
    ->leftJoin('order_items', 'products.id', '=', 'order_items.product_id')
    ->leftJoin('reviews', 'products.id', '=', 'reviews.product_id')
    ->groupBy('products.id')
    ->having('order_count', '>', 10)
    ->orderByDesc('total_sold')
    ->limit(20)
    ->get();
```

## 5. Middleware ูุฎุตุต ููุฃูุงู

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Support\Facades\RateLimiter;

class SecurityMiddleware
{
    public function handle($request, Closure $next)
    {
        // ุงูุชุญูู ูู ูุนุฏู ุงูุทูุจุงุช
        $key = 'security:' . $request->ip();
        
        if (RateLimiter::tooManyAttempts($key, 100)) {
            return response()->json([
                'message' => 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ ูู ุงูุทูุจุงุช'
            ], 429);
        }
        
        RateLimiter::hit($key, 60);
        
        // ุงูุชุญูู ูู ุฑุคูุณ ุงูุฃูุงู
        if (!$request->hasHeader('X-Requested-With')) {
            return response()->json([
                'message' => 'ุทูุจ ุบูุฑ ุตุงูุญ'
            ], 400);
        }
        
        // ุชุณุฌูู ุงููุดุงุท ุงููุดุจูู
        if ($this->isSuspiciousRequest($request)) {
            Log::warning('Suspicious request detected', [
                'ip' => $request->ip(),
                'url' => $request->fullUrl(),
                'user_agent' => $request->userAgent()
            ]);
        }
        
        $response = $next($request);
        
        // ุฅุถุงูุฉ ุฑุคูุณ ุงูุฃูุงู
        $response->headers->set('X-Content-Type-Options', 'nosniff');
        $response->headers->set('X-Frame-Options', 'DENY');
        $response->headers->set('X-XSS-Protection', '1; mode=block');
        
        return $response;
    }
    
    private function isSuspiciousRequest($request)
    {
        $suspiciousPatterns = [
            '/\.\./i',           // ูุญุงููุฉ ุงููุตูู ูููุฌูุฏุงุช ุงูุฃุนูู
            '/union.*select/i',  // SQL injection
            '/<script/i',        // XSS
            '/eval\(/i',         // ุชูููุฐ ููุฏ
        ];
        
        $input = $request->all();
        $inputString = json_encode($input);
        
        foreach ($suspiciousPatterns as $pattern) {
            if (preg_match($pattern, $inputString)) {
                return true;
            }
        }
        
        return false;
    }
}
```

---
*ุฃูุซูุฉ Laravel ูุชูุฏูุฉ - ูุดุฑูุน Zero - ููุท ุงูุฃุณุทูุฑุฉ โ๏ธ*