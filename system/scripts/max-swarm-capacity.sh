#!/bin/bash

# ุญุณุงุจ ุงูุณุนุฉ ุงููุตูู ุงูููููุฉ ููุณุฑุจ
# Maximum Swarm Capacity Calculator

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ          ๐ ุญุณุงุจ ุงูุณุนุฉ ุงููุตูู ููุณุฑุจ                        โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ุฌูุน ูุนูููุงุช ุงููุธุงู
CPU_CORES=$(nproc)
TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}')
AVAILABLE_MEM=$(free -m | awk '/^Mem:/{print $7}')
LOAD_AVG=$(uptime | awk -F'load average:' '{print $2}' | awk -F',' '{print $1}' | xargs)
LOAD_PERCENT=$(echo "scale=2; ($LOAD_AVG / $CPU_CORES) * 100" | bc 2>/dev/null || echo "10")

# ูุนูููุงุช ุงููุฑุต
DISK_INFO=$(df -h /workspace | tail -1)
DISK_TOTAL=$(echo $DISK_INFO | awk '{print $2}')
DISK_AVAIL=$(echo $DISK_INFO | awk '{print $4}')

echo "๐ ููุงุฑุฏ ุงููุธุงู ุงูุญุงููุฉ:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โข ุงููุนุงูุฌ: $CPU_CORES ุฃูููุฉ"
echo "โข ุงูุฐุงูุฑุฉ ุงููููุฉ: ${TOTAL_MEM}MB"
echo "โข ุงูุฐุงูุฑุฉ ุงููุชุงุญุฉ: ${AVAILABLE_MEM}MB"
echo "โข ุญูู ุงููุธุงู: ${LOAD_PERCENT:-10}%"
echo "โข ุงููุฑุต ุงููุชุงุญ: $DISK_AVAIL"
echo ""

# ุญุณุงุจ ุงูุณุนุฉ ุงููุตูู ุจูุงุกู ุนูู ุนูุงูู ูุฎุชููุฉ
echo "๐ ุญุณุงุจ ุงูุณุนุฉ ุงููุตูู:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# 1. ุจูุงุกู ุนูู ุงููุนุงูุฌ (50-100 ูุญุฏุฉ ููู ููุงุฉ)
MAX_CPU_CONSERVATIVE=$((CPU_CORES * 50))
MAX_CPU_AGGRESSIVE=$((CPU_CORES * 100))
echo "โข ุจูุงุกู ุนูู ุงููุนุงูุฌ:"
echo "  - ูุญุงูุธ (50/ููุงุฉ): $MAX_CPU_CONSERVATIVE ูุญุฏุฉ"
echo "  - ูุชูุณุท (75/ููุงุฉ): $((CPU_CORES * 75)) ูุญุฏุฉ"
echo "  - ุฌุฑูุก (100/ููุงุฉ): $MAX_CPU_AGGRESSIVE ูุญุฏุฉ"

# 2. ุจูุงุกู ุนูู ุงูุฐุงูุฑุฉ (20-50MB ููู ูุญุฏุฉ)
MAX_MEM_CONSERVATIVE=$((AVAILABLE_MEM / 50))
MAX_MEM_AGGRESSIVE=$((AVAILABLE_MEM / 20))
echo ""
echo "โข ุจูุงุกู ุนูู ุงูุฐุงูุฑุฉ:"
echo "  - ูุญุงูุธ (50MB/ูุญุฏุฉ): $MAX_MEM_CONSERVATIVE ูุญุฏุฉ"
echo "  - ูุชูุณุท (35MB/ูุญุฏุฉ): $((AVAILABLE_MEM / 35)) ูุญุฏุฉ"
echo "  - ุฌุฑูุก (20MB/ูุญุฏุฉ): $MAX_MEM_AGGRESSIVE ูุญุฏุฉ"

# 3. ุจูุงุกู ุนูู ุงูุญูู ุงูุญุงูู
if [ -n "$LOAD_PERCENT" ]; then
    LOAD_FACTOR=$((100 - ${LOAD_PERCENT%.*}))
    MAX_LOAD=$((LOAD_FACTOR * 3))
    echo ""
    echo "โข ุจูุงุกู ุนูู ุงูุญูู ุงูุญุงูู:"
    echo "  - ุนุงูู ุงูุญูู: ${LOAD_FACTOR}%"
    echo "  - ุงูุณุนุฉ ุงููุชุงุญุฉ: $MAX_LOAD ูุญุฏุฉ"
fi

echo ""
echo "๐ฏ ุงูุชูุตูุงุช:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ุญุณุงุจ ุงูุณุนุฉ ุงููุซูู
OPTIMAL_CPU=$((CPU_CORES * 75))
OPTIMAL_MEM=$((AVAILABLE_MEM / 30))
OPTIMAL_LOAD=${MAX_LOAD:-200}

# ุงุฎุชูุงุฑ ุงูุฃูู
if [ $OPTIMAL_CPU -le $OPTIMAL_MEM ] && [ $OPTIMAL_CPU -le $OPTIMAL_LOAD ]; then
    OPTIMAL=$OPTIMAL_CPU
    LIMITING="ุงููุนุงูุฌ"
elif [ $OPTIMAL_MEM -le $OPTIMAL_LOAD ]; then
    OPTIMAL=$OPTIMAL_MEM
    LIMITING="ุงูุฐุงูุฑุฉ"
else
    OPTIMAL=$OPTIMAL_LOAD
    LIMITING="ุญูู ุงููุธุงู"
fi

# ุงูุณุนุฉ ุงููุตูู ุงููุทููุฉ
ABSOLUTE_MAX=$((CPU_CORES * 100))
if [ $((AVAILABLE_MEM / 20)) -lt $ABSOLUTE_MAX ]; then
    ABSOLUTE_MAX=$((AVAILABLE_MEM / 20))
fi

echo "โข ุงูุณุนุฉ ุงููุซูู ุงูููุตู ุจูุง: $OPTIMAL ูุญุฏุฉ"
echo "โข ุงูุนุงูู ุงููุญุฏุฏ: $LIMITING"
echo "โข ุงูุณุนุฉ ุงููุตูู ุงููุทููุฉ: $ABSOLUTE_MAX ูุญุฏุฉ"
echo ""

# ุชูุฒูุน ููุชุฑุญ ููุณุนุฉ ุงููุตูู
echo "๐ ุงูุชูุฒูุน ุงูููุชุฑุญ ููุณุนุฉ ุงููุตูู ($ABSOLUTE_MAX ูุญุฏุฉ):"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โข ุงูุชุญููู (20%): $((ABSOLUTE_MAX * 20 / 100)) ูุญุฏุฉ"
echo "โข ุงูุชุทููุฑ (30%): $((ABSOLUTE_MAX * 30 / 100)) ูุญุฏุฉ"
echo "โข ุงูุงุฎุชุจุงุฑ (20%): $((ABSOLUTE_MAX * 20 / 100)) ูุญุฏุฉ"
echo "โข ุงูุชุญุณูู (15%): $((ABSOLUTE_MAX * 15 / 100)) ูุญุฏุฉ"
echo "โข ุงูุฃุชูุชุฉ (10%): $((ABSOLUTE_MAX * 10 / 100)) ูุญุฏุฉ"
echo "โข ุงููุฑุงูุจุฉ (5%): $((ABSOLUTE_MAX * 5 / 100)) ูุญุฏุฉ"
echo ""

# ุชูููู ุงูุฃุฏุงุก ุงููุชููุน
echo "โก ุงูุฃุฏุงุก ุงููุชููุน:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
if [ $ABSOLUTE_MAX -ge 500 ]; then
    echo "โ ุฃุฏุงุก ูุงุฆู - ูููู ูุนุงูุฌุฉ ูุดุงุฑูุน ุถุฎูุฉ ุจููุงุกุฉ ุนุงููุฉ"
    echo "โ ุชูููุฐ ูุชูุงุฒู ููุชุงุฒ ูุฌููุน ุงูููุงู"
    echo "โ ูุฏุฑุฉ ุนูู ุงูุชุนุงูู ูุน ุฃุญูุงู ุฐุฑูุฉ ุนุงููุฉ"
elif [ $ABSOLUTE_MAX -ge 200 ]; then
    echo "โ ุฃุฏุงุก ููุชุงุฒ - ููุงุณุจ ูููุดุงุฑูุน ุงููุจูุฑุฉ"
    echo "โ ุชูุงุฒู ุฌูุฏ ุฌุฏุงู ูุน ููุงุกุฉ ุนุงููุฉ"
    echo "โ๏ธ ูุฏ ูุญุชุงุฌ ุชุญุณูู ูู ุฃุญูุงู ุงูุฐุฑูุฉ"
elif [ $ABSOLUTE_MAX -ge 100 ]; then
    echo "โ ุฃุฏุงุก ุฌูุฏ - ููุงุณุจ ูููุดุงุฑูุน ุงููุชูุณุทุฉ"
    echo "โ๏ธ ุชูุงุฒู ูุญุฏูุฏ ูู ุงูููุงู ุงูุซูููุฉ"
    echo "โ๏ธ ูููุตุญ ุจุชุญุณูู ุงูููุงุฑุฏ ูููุดุงุฑูุน ุงููุจูุฑุฉ"
else
    echo "โ๏ธ ุฃุฏุงุก ูุญุฏูุฏ - ููุงุณุจ ูููุดุงุฑูุน ุงูุตุบูุฑุฉ"
    echo "โ๏ธ ูุฏุฑุฉ ูุญุฏูุฏุฉ ุนูู ุงูุชูุงุฒู"
    echo "โ ูููุตุญ ุจุชุฑููุฉ ุงูููุงุฑุฏ ููุฃุฏุงุก ุงูุฃูุซู"
fi

echo ""
echo "๐ก ูุตุงุฆุญ ูุฒูุงุฏุฉ ุงูุณุนุฉ:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "1. ุฒูุงุฏุฉ ุงูุฐุงูุฑุฉ RAM ูููุธุงู"
echo "2. ุงุณุชุฎุฏุงู ูุนุงูุฌ ุจุนุฏุฏ ุฃูููุฉ ุฃูุจุฑ"
echo "3. ุชูููู ุงูุนูููุงุช ุงูุฎูููุฉ ุบูุฑ ุงูุถุฑูุฑูุฉ"
echo "4. ุชุญุณูู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ ูู ุงูุชุทุจููุงุช"
echo "5. ุงุณุชุฎุฏุงู SSD ูุชุญุณูู ุณุฑุนุฉ I/O"

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                    โ ุงูุชูู ุงูุชุญููู                         โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"